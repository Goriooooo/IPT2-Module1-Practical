<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Calendar API Test</title>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #d97706;
      margin-bottom: 20px;
    }
    button {
      background: #d97706;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
    }
    button:hover {
      background: #b45309;
    }
    #output {
      margin-top: 20px;
      padding: 15px;
      background: #f9fafb;
      border-radius: 5px;
      border-left: 4px solid #d97706;
    }
    .success {
      color: #10b981;
      font-weight: bold;
    }
    .error {
      color: #ef4444;
      font-weight: bold;
    }
    .warning {
      color: #f59e0b;
      font-weight: bold;
    }
    .info {
      color: #3b82f6;
    }
    pre {
      background: #1f2937;
      color: #e5e7eb;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üóìÔ∏è Google Calendar API Diagnostic Test</h1>
    
    <div>
      <h3>Step 1: Check Configuration</h3>
      <button onclick="checkConfig()">Check Config</button>
    </div>

    <div>
      <h3>Step 2: Initialize API</h3>
      <button onclick="testInit()">Initialize API</button>
    </div>

    <div>
      <h3>Step 3: Test Authentication</h3>
      <button onclick="testAuth()">Sign In</button>
      <button onclick="testSignOut()">Sign Out</button>
    </div>

    <div>
      <h3>Step 4: Test Calendar Access</h3>
      <button onclick="testListCalendars()">List Calendars</button>
      <button onclick="testCreateEvent()">Create Test Event</button>
    </div>

    <div id="output">
      <p class="info">üëÜ Click buttons above to test each step</p>
    </div>
  </div>

  <script>
    // IMPORTANT: Update these with your actual values from .env
    const CONFIG = {
      CLIENT_ID: '841373914511-o22k743e7ahugch4374iljiquc821gub.apps.googleusercontent.com',
      API_KEY: 'AIzaSyCBfCdqW26r5OHoLrLXHUt6kLKabq11UvI',
      CALENDAR_ID: 'zcelmacasling@gmail.com',
      SCOPES: 'https://www.googleapis.com/auth/calendar.events',
      DISCOVERY_DOCS: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest']
    };

    let output = document.getElementById('output');
    let isInitialized = false;

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const className = type;
      output.innerHTML += `<p class="${className}">[${timestamp}] ${message}</p>`;
      output.scrollTop = output.scrollHeight;
    }

    function checkConfig() {
      output.innerHTML = '<h4>Configuration Check:</h4>';
      
      log('Checking API Key...', 'info');
      if (CONFIG.API_KEY && CONFIG.API_KEY.startsWith('AIza')) {
        log('‚úÖ API Key format is correct', 'success');
      } else {
        log('‚ùå API Key is missing or incorrect format', 'error');
        log('üí° Should start with "AIza"', 'warning');
      }

      log('Checking Client ID...', 'info');
      if (CONFIG.CLIENT_ID && CONFIG.CLIENT_ID.includes('.apps.googleusercontent.com')) {
        log('‚úÖ Client ID format is correct', 'success');
      } else {
        log('‚ùå Client ID is missing or incorrect format', 'error');
        log('üí° Should end with ".apps.googleusercontent.com"', 'warning');
      }

      log('Checking Calendar ID...', 'info');
      if (CONFIG.CALENDAR_ID) {
        log(`‚úÖ Calendar ID: ${CONFIG.CALENDAR_ID}`, 'success');
      } else {
        log('‚ùå Calendar ID is missing', 'error');
      }

      log('Checking GAPI...', 'info');
      if (typeof gapi !== 'undefined') {
        log('‚úÖ Google API (gapi) is loaded', 'success');
      } else {
        log('‚ùå Google API (gapi) is NOT loaded', 'error');
      }
    }

    function testInit() {
      log('Initializing Google Calendar API...', 'info');
      
      if (!CONFIG.API_KEY || !CONFIG.CLIENT_ID) {
        log('‚ùå Cannot initialize: Missing credentials', 'error');
        return;
      }

      gapi.load('client:auth2', async () => {
        try {
          log('üì¶ GAPI loaded, initializing client...', 'info');
          
          await gapi.client.init({
            apiKey: CONFIG.API_KEY,
            clientId: CONFIG.CLIENT_ID,
            discoveryDocs: CONFIG.DISCOVERY_DOCS,
            scope: CONFIG.SCOPES
          });

          isInitialized = true;
          log('‚úÖ Google Calendar API initialized successfully!', 'success');
          log('üí° Now try "Sign In" button', 'info');
        } catch (error) {
          log('‚ùå Initialization failed:', 'error');
          log(`Error: ${error.message}`, 'error');
          
          if (error.details) {
            log('<pre>' + JSON.stringify(error.details, null, 2) + '</pre>', 'error');
          }

          // Common error solutions
          if (error.message.includes('API key')) {
            log('üí° Solution: Check if Calendar API is enabled in Google Cloud Console', 'warning');
            log('üí° Link: https://console.cloud.google.com/apis/library/calendar-json.googleapis.com', 'warning');
          } else if (error.message.includes('origin')) {
            log('üí° Solution: Add authorized JavaScript origin in Google Cloud Console', 'warning');
            log('üí° Add: http://localhost:5173', 'warning');
          }
        }
      });
    }

    function testAuth() {
      if (!isInitialized) {
        log('‚ùå Please initialize API first', 'error');
        return;
      }

      log('üîê Attempting to sign in...', 'info');
      
      const authInstance = gapi.auth2.getAuthInstance();
      
      if (authInstance.isSignedIn.get()) {
        log('‚ÑπÔ∏è Already signed in!', 'info');
        const user = authInstance.currentUser.get();
        const profile = user.getBasicProfile();
        log(`‚úÖ Signed in as: ${profile.getEmail()}`, 'success');
        return;
      }

      authInstance.signIn({
        prompt: 'select_account'
      }).then(() => {
        const user = authInstance.currentUser.get();
        const profile = user.getBasicProfile();
        log('‚úÖ Sign in successful!', 'success');
        log(`üë§ User: ${profile.getName()}`, 'success');
        log(`üìß Email: ${profile.getEmail()}`, 'success');
        log('üí° Now try "List Calendars" or "Create Test Event"', 'info');
      }).catch((error) => {
        log('‚ùå Sign in failed:', 'error');
        log(`Error: ${error.error}`, 'error');
        
        if (error.error === 'popup_closed_by_user') {
          log('üí° You closed the popup. Please try again and complete the sign-in.', 'warning');
        } else if (error.error === 'access_denied') {
          log('üí° You denied access. Please try again and allow permissions.', 'warning');
        } else if (error.error === 'idpiframe_initialization_failed') {
          log('üí° OAuth configuration issue. Check:', 'warning');
          log('   1. Client ID is correct', 'warning');
          log('   2. Authorized JavaScript origins include: http://localhost:5173', 'warning');
          log('   3. OAuth consent screen is configured', 'warning');
        }
      });
    }

    function testSignOut() {
      if (!isInitialized) {
        log('‚ùå Please initialize API first', 'error');
        return;
      }

      const authInstance = gapi.auth2.getAuthInstance();
      authInstance.signOut().then(() => {
        log('‚úÖ Signed out successfully', 'success');
      });
    }

    function testListCalendars() {
      if (!isInitialized) {
        log('‚ùå Please initialize API first', 'error');
        return;
      }

      const authInstance = gapi.auth2.getAuthInstance();
      if (!authInstance.isSignedIn.get()) {
        log('‚ùå Please sign in first', 'error');
        return;
      }

      log('üìã Fetching calendar list...', 'info');

      gapi.client.calendar.calendarList.list().then((response) => {
        const calendars = response.result.items;
        log(`‚úÖ Found ${calendars.length} calendars:`, 'success');
        
        calendars.forEach((cal) => {
          log(`   üìÖ ${cal.summary} (${cal.id})`, 'info');
        });
      }).catch((error) => {
        log('‚ùå Failed to list calendars:', 'error');
        log(`Error: ${error.message}`, 'error');
      });
    }

    function testCreateEvent() {
      if (!isInitialized) {
        log('‚ùå Please initialize API first', 'error');
        return;
      }

      const authInstance = gapi.auth2.getAuthInstance();
      if (!authInstance.isSignedIn.get()) {
        log('‚ùå Please sign in first', 'error');
        return;
      }

      log('üìù Creating test event...', 'info');

      const now = new Date();
      const tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000);
      tomorrow.setHours(14, 0, 0, 0); // 2 PM tomorrow
      
      const endTime = new Date(tomorrow.getTime() + 2 * 60 * 60 * 1000); // +2 hours

      const event = {
        summary: 'Test Reservation - Eris Cafe',
        description: 'This is a test event created by the diagnostic tool.',
        start: {
          dateTime: tomorrow.toISOString(),
          timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
        },
        end: {
          dateTime: endTime.toISOString(),
          timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
        },
        colorId: '10' // Green
      };

      gapi.client.calendar.events.insert({
        calendarId: CONFIG.CALENDAR_ID,
        resource: event
      }).then((response) => {
        log('‚úÖ Test event created successfully!', 'success');
        log(`üìÖ Event: ${response.result.summary}`, 'success');
        log(`üîó View: ${response.result.htmlLink}`, 'success');
        log(`üÜî Event ID: ${response.result.id}`, 'info');
        log('üí° Check your Google Calendar!', 'info');
      }).catch((error) => {
        log('‚ùå Failed to create event:', 'error');
        log(`Error: ${error.message}`, 'error');
        
        if (error.result && error.result.error) {
          log(`Details: ${error.result.error.message}`, 'error');
        }
      });
    }
  </script>
</body>
</html>
